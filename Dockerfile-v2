# Start from the official 'base' image which is a clean ComfyUI install
FROM runpod/worker-comfyui:5.5.0-base

# Install OpenCV and other dependencies required for face detection and custom nodes
RUN pip install --no-cache-dir opencv-python opencv-contrib-python transformers accelerate

# Install custom nodes using comfy-node-install (supports URLs)
RUN comfy-node-install \
    https://github.com/RndNanthu/ComfyUI-RndNanthu \
    https://github.com/numz/ComfyUI-SeedVR2_VideoUpscaler \
    https://github.com/chflame163/ComfyUI_LayerStyle_Advance \
    https://github.com/MoonGoblinDev/Civicomfy \
    https://github.com/kijai/ComfyUI-Florence2 \
    https://github.com/Suzie1/ComfyUI_Comfyroll_CustomNodes \
    https://github.com/cubiq/ComfyUI_essentials \
    https://github.com/pythongosssss/ComfyUI-Custom-Scripts \
    https://github.com/rgthree/rgthree-comfy \
    https://github.com/kijai/ComfyUI-KJNodes

# Install git for branch checkout
RUN apt-get update && apt-get install -y git

# Special handling for ComfyUI-SeedVR2_VideoUpscaler (switch to nightly branch)
RUN cd /comfyui/custom_nodes/ComfyUI-SeedVR2_VideoUpscaler && git checkout nightly

# Install requirements for nodes that need them
RUN cd /comfyui/custom_nodes/ComfyUI-RndNanthu && pip install -r requirements.txt
RUN cd /comfyui/custom_nodes/ComfyUI-SeedVR2_VideoUpscaler && pip install -r requirements.txt
RUN cd /comfyui/custom_nodes/ComfyUI_LayerStyle_Advance && pip install -r requirements.txt
RUN cd /comfyui/custom_nodes/ComfyUI-Florence2 && pip install -r requirements.txt
RUN cd /comfyui/custom_nodes/ComfyUI_Comfyroll_CustomNodes && pip install -r requirements.txt
RUN cd /comfyui/custom_nodes/ComfyUI-KJNodes && pip install -r requirements.txt
RUN cd /comfyui/custom_nodes/Civicomfy && if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
RUN cd /comfyui/custom_nodes/ComfyUI-Custom-Scripts && if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
RUN cd /comfyui/custom_nodes/rgthree-comfy && if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

# Download models
# 16GB SeedVR2 Upscaler
RUN mkdir -p /comfyui/models/upscale_models && \
    wget -O /comfyui/models/upscale_models/seedvr2_ema_7b_fp16.safetensors "https://huggingface.co/numz/SeedVR2_comfyUI/resolve/main/seedvr2_ema_7b_fp16.safetensors"

# 6GB VXVI_LastFame_DMD2 Checkpoint
RUN mkdir -p /comfyui/models/checkpoints && \
    wget -O /comfyui/models/checkpoints/VXVI_LastFame_DMD2.safetensors "https://civitai.com/api/download/models/484695"

# ComfyUI-Manager is already included in the base image, no need to install it